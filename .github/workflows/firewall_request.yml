name: ğŸ”’ Process Firewall Requests

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write       # for checkout & PR creation
  issues:   write       # for commenting on issues
  pull-requests: write  # for opening PRs

jobs:
  process:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'firewall-request')

    steps:
      # 1ï¸âƒ£ Check out the repository
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2ï¸âƒ£ Parse the Issue into an array of rule objects
      - name: ğŸ“ Parse issue into JSON
        id: parse
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const issue = context.payload.issue;
            if (!issue?.body) throw new Error("No issue body found");

            const lines = issue.body.split("\n");
            // extract Request ID
            const idLine = lines.find(
              l => l.startsWith("ğŸ”¹ Request ID") || l.startsWith("### Request ID")
            );
            if (!idLine) throw new Error("Missing Request ID");
            const request_id_reqid = idLine.split(/:\s*/, 2)[1]?.trim();
            if (!request_id_reqid) throw new Error("Empty Request ID");

            const rules = [];
            let current = null;

            for (const raw of lines) {
              const l = raw.trim();
              // start a new rule block
              if (/^####\s*Rule\s*\d+/.test(l)) {
                if (current) rules.push(current);
                current = { request_id_reqid };
                continue;
              }
              if (!current) continue;
              if (l.startsWith("ğŸ”¹")) {
                const parts = l.replace(/^ğŸ”¹\s*/, "").split(/:\s*/, 2);
                const rawKey = parts[0];
                const rawVal = parts[1] ?? "";
                const key = rawKey
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, "_")
                  .replace(/_+$/,"");
                const val = rawVal.trim().replace(/^|$/g,"");
                current[key] = val;
              }
            }
            if (current) rules.push(current);

            return JSON.stringify({ rules });

      # 3ï¸âƒ£ Persist the parsed payload to disk
      - name: ğŸ’¾ Save parsed JSON
        run: echo '${{ steps.parse.outputs.result }}' > parsed.json

      # 4ï¸âƒ£ Run validation on each rule (job wonâ€™t abort here)
      - name: âœ… Run validation
        id: validate
        continue-on-error: true
        run: |
          set -o pipefail
          exit_code=0
          > validation.log
          while IFS= read -r rule; do
            echo "Validating rule: $rule" | tee -a validation.log
            python3 scripts/validate_firewall_request.py "$rule" 2>&1 | tee -a validation.log || exit_code=1
          done < <(jq -c '.rules[]' parsed.json)
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        shell: bash

      # 5ï¸âƒ£ If validation failed, comment back to the Issue
      - name: ğŸ’¬ Comment on validation failure
        if: steps.validate.outputs.exit_code != '0'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errs = require('fs').readFileSync('validation.log','utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.issue.number,
              body: âš ï¸ **Validation failed** for your firewall request:\n\\\\n${errs}\n\\\\nPlease correct and re-open this issue when ready.
            });

      # 6ï¸âƒ£ Skip the rest if validation failed
      - name: â­ï¸ Skip remaining steps on validation error
        if: steps.validate.outputs.exit_code != '0'
        run: echo "Validation errors detected; skipping Terraform & PR steps."

      # 7ï¸âƒ£ Build the PR body (only on success)
      - name: âœ¨ Build PR body
        if: steps.validate.outputs.exit_code == '0'
        id: build_pr_body
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const parsed = JSON.parse(\${{ steps.parse.outputs.result }});
            const lines = parsed.rules
              .map((r,i) => - Rule ${i+1}: ${r.source_ip_s_or_cidr_s} â†’ ${r.destination_ip_s_or_cidr_s} on ${r.protocol}/${r.port_s})
              .join("\n");
            return Auto-generated firewall rules for **${parsed.rules[0].request_id_reqid}**:\n\n${lines}\n\nCloses #${{ github.event.issue.number }};

      # 8ï¸âƒ£ Setup Terraform (only on success)
      - name: âš™ï¸ Setup Terraform
        if: steps.validate.outputs.exit_code == '0'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      # 9ï¸âƒ£ Inject rules into your tfvars file (only on success)
      - name: âœï¸ Inject rules into tfvars
        if: steps.validate.outputs.exit_code == '0'
        run: |
          python3 scripts/add_firewall_rule.py "$(cat parsed.json)" e1inetpolicy.auto.tfvars.json

      # ğŸ”Ÿ Terraform fmt & validate (only on success)
      - name: ğŸ§¹ Terraform fmt & validate
        if: steps.validate.outputs.exit_code == '0'
        env:
          TF_IN_AUTOMATION: true
        run: |
          terraform init -backend=false
          terraform fmt -recursive
          terraform validate

      # 1ï¸âƒ£1ï¸âƒ£ Cleanup Terraform runtime files (only on success)
      - name: ğŸ—‘ï¸ Cleanup Terraform runtime files
        if: steps.validate.outputs.exit_code == '0'
        run: rm -rf .terraform .terraform.lock.hcl

      # 1ï¸âƒ£2ï¸âƒ£ Create Pull Request for NetSec review (only on success)
      - name: ğŸ”€ Create PR for NetSec review
        if: steps.validate.outputs.exit_code == '0'
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: firewall-req-${{ fromJson(steps.parse.outputs.result).rules[0].request_id_reqid }}
          title: "[Firewall] ${{ fromJson(steps.parse.outputs.result).rules[0].request_id_reqid }} â€“ ${{ fromJson(steps.parse.outputs.result).rules[0].protocol }}/${{ fromJson(steps.parse.outputs.result).rules[0].port_s }}"
          labels: firewall-rule,pending-review
          body: ${{ steps.build_pr_body.outputs.result }}