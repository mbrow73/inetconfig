name: 🔒 Process Firewall Requests

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues:   write
  pull-requests: write

jobs:
  process:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'firewall-request')

    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 📝 Parse issue into JSON
        id: parse
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const issue = context.payload.issue;
            if (!issue?.body) throw new Error("No issue body found");
            const lines = issue.body.split("\n").map(l=>l.trim());
            const obj = {};
            for(let i=0;i<lines.length;i++){
              if(!lines[i].startsWith("🔹")) continue;
              const after = lines[i].replace(/^🔹\s*/,"");
              let [rawKey, inlineVal] = after.split(/:\s*/,2);
              rawKey=rawKey.replace(/:$/,"");
              const key = rawKey.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/_+$/,"");
              let val = inlineVal?.trim()||"";
              if(!val){
                let j=i+1; while(j<lines.length && !lines[j]) j++;
                if(j>=lines.length) throw new Error(`No value for "${rawKey}"`);
                val = lines[j];
              }
              obj[key]=val;
            }
            return JSON.stringify(obj);

      - name: ✅ Validate request fields
        id: validate
        continue-on-error: true
        run: |
          set -o pipefail
          python3 scripts/validate_firewall_request.py '${{ steps.parse.outputs.result }}' 2>&1 | tee validation.log
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        shell: bash

      - name: 💬 Comment on validation failure
        if: steps.validate.outputs.exitcode != '0'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errs = require('fs').readFileSync('validation.log','utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `⚠️ **Validation failed**:\n\`\`\`\n${errs}\n\`\`\`\nPlease correct and then re-open this issue when ready.`
            });

      # Only run these if validation passed
      - name: ⚙️ Setup Terraform & Inject & PR
        if: steps.validate.outputs.exitcode == '0'
        run: |
          # Terraform setup
          echo "Injecting rule and opening PR…"
        # Expand into your existing steps:
      - name: ✍️ Inject rule into tfvars
        if: steps.validate.outputs.exitcode == '0'
        run: |
          python3 scripts/add_firewall_rule.py '${{ steps.parse.outputs.result }}' e1inetpolicy.auto.tfvars.json

      - name: 🧹 Terraform fmt & validate
        if: steps.validate.outputs.exitcode == '0'
        env:
          TF_IN_AUTOMATION: true
        run: |
          terraform init -backend=false
          terraform fmt -recursive
          terraform validate

      - name: 🗑️ Cleanup Terraform runtime files
        if: steps.validate.outputs.exitcode == '0'
        run: |
          rm -rf .terraform .terraform.lock.hcl

      - name: 🔀 Create PR for NetSec review
        if: steps.validate.outputs.exitcode == '0'
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: firewall-req-${{ fromJson(steps.parse.outputs.result).request_id_reqid }}
          title: "[Firewall] ${{ fromJson(steps.parse.outputs.result).request_id_reqid }} – ${{ fromJson(steps.parse.outputs.result).protocol }}/${{ fromJson(steps.parse.outputs.result).port_s }}"
          labels: firewall-rule,pending-review
          body: |
            Auto-generated firewall rule for **${{ fromJson(steps.parse.outputs.result).request_id_reqid }}**

            - **Source:** ${{ fromJson(steps.parse.outputs.result).source_ip_s_or_cidr_s }}
            - **Destination:** ${{ fromJson(steps.parse.outputs.result).destination_ip_s_or_cidr_s }}
            - **Port(s):** ${{ fromJson(steps.parse.outputs.result).port_s }}
            - **Protocol:** ${{ fromJson(steps.parse.outputs.result).protocol }}
            - **Direction:** ${{ fromJson(steps.parse.outputs.result).direction }}

            Closes #${{ github.event.issue.number }}
