name: "🔄 Process Firewall Rule Update/Removal"

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'firewall-update-request')

    steps:
      - name: "⬇️ Checkout repo"
        uses: actions/checkout@v3

      - name: "💾 Save form inputs to file"
        run: |
          echo "${{ toJson(github.event.inputs) }}" > inputs.json

      - name: "🔎 Update/Remove Rule in tfvars (with validation)"
        id: update
        run: |
          python3 scripts/update_remove_firewall_rule.py \
            inputs.json \
            automation.auto.tfvars.json \
            updated.auto.tfvars.json

      - name: "🧹 Terraform fmt & validate"
        run: |
          terraform init -backend=false
          terraform fmt -recursive
          terraform validate

      - name: "🔀 Create PR for Review"
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: rule-update-${{ fromJson(steps.update.outputs.result).reqid }}
          title: "[Firewall] Update/Remove via ${{ fromJson(steps.update.outputs.result).reqid }}"
          body: |
            This PR updates/removes rules per REQID ${{ fromJson(steps.update.outputs.result).reqid }}.
            Please review and merge.
          commit-message: "Update/remove firewall rule(s) per REQID ${{ fromJson(steps.update.outputs.result).reqid }}"
          add-paths: updated.auto.tfvars.json
          labels: firewall-rule${{ steps.update.outputs.ownership_changed == 'true' && ',ownership-change' || '' }}
