name: "🔄 Process Firewall Rule Change"

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'firewall-change-request')

    steps:
      - name: "⬇️ Checkout repo"
        uses: actions/checkout@v3

      - name: "💾 Save form inputs"
        run: |
          echo "${{ toJson(github.event.inputs) }}" > inputs.json

      - name: "🔎 Update/Remove Rule in tfvars"
        id: change
        run: |
          python3 scripts/update_remove_firewall_rule.py \
            inputs.json \
            automation.auto.tfvars.json \
            updated.auto.tfvars.json

      - name: "🧹 Terraform fmt & validate"
        run: |
          terraform init -backend=false
          terraform fmt -recursive
          terraform validate

      - name: "🔀 Create Pull Request"
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Use the reqid and action outputs directly—no pipes needed
          branch: rule-change-${{ steps.change.outputs.reqid }}
          title: "[Firewall] ${{ steps.change.outputs.action }} via ${{ steps.change.outputs.reqid }}"
          body: ${{ steps.change.outputs.pr_body }}
          commit-message: "Firewall rule ${{ steps.change.outputs.action }} per ${{ steps.change.outputs.reqid }}"
          add-paths: updated.auto.tfvars.json
          labels: ${{ steps.change.outputs.ownership_changed == 'true' && 'firewall-rule,ownership-change' || 'firewall-rule' }}
