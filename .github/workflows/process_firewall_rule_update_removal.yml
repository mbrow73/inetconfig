name: üîÑ Process Firewall Rule Update/Removal

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  process:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'firewall-update-request')
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: üìù Parse Issue (convert to JSON for script)
        id: parse
        run: |
          python3 scripts/parse_update_issue.py "${{ github.event.issue.body }}" > parsed_update.json

      - name: üõ°Ô∏è Update or Remove Rule in tfvars (with validation)
        id: update
        run: |
          python3 scripts/update_remove_firewall_rule.py parsed_update.json automation.auto.tfvars.json updated.auto.tfvars.json

      - name: üö¶ Create PR for Review (label if ownership changes)
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: rule-update-${{ fromJson(steps.parse.outputs.result).reqid }}
          title: |
            [Firewall] Rule Update/Remove via ${{ fromJson(steps.parse.outputs.result).reqid }}
          body: |
            This PR updates or removes rules per REQID ${{ fromJson(steps.parse.outputs.result).reqid }}.
            Please review and merge.
          commit-message: "Update/remove firewall rule(s) per REQID ${{ fromJson(steps.parse.outputs.result).reqid }}"
          add-paths: |
            updated.auto.tfvars.json
          labels: ${{ steps.update.outputs.ownership_changed == 'true' && 'firewall-rule,ownership-change' || 'firewall-rule' }}
